sudo: false

language: go
go:
  - 1.8.x
  - 1.9.x
  - 1.10.x
  - master

matrix:
  allow_failures:
    - go: master

env:
  - IGNORE_BREAKING_CHANGES=true

install:
  - go get -u github.com/golang/lint/golint
  - go get -u github.com/golang/dep/cmd/dep
  - dep ensure

script:
  - bash rungas.sh
  - grep -L -r --include *.go --exclude-dir vendor -P "Copyright (\d{4}|\(c\)) Microsoft" ./ | tee /dev/stderr | test -z "$(< /dev/stdin)"
  - go build $(go list ./... | grep -v vendor)
  - test -z "$(go fmt $(go list ./... | grep -v vendor) | tee /dev/stderr)"
  - go vet $(go list ./... | grep -v vendor)
  - go test $(sh ./findTestedPackages.sh)
  - go run ./tools/apidiff/main.go packages ./services FETCH_HEAD~1 FETCH_HEAD --copyrepo --breakingchanges || $IGNORE_BREAKING_CHANGES
