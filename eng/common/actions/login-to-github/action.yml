# Login to GitHub - Composite Action
#
# Mints a GitHub App installation access token using Azure Key Vault signing.
# This action wraps eng/common/scripts/login-to-github.ps1 for use in GitHub
# Actions workflows. The same script is used by Azure DevOps pipelines via
# eng/common/pipelines/templates/steps/login-to-github.yml.
#
# IMPORTANT: This action requires Azure CLI to be pre-authenticated.
# You must call azure/login BEFORE this action in your workflow.
# This is because composite actions cannot call azure/login internally.
#
# Usage (single owner):
#   jobs:
#     my-job:
#       permissions:
#         id-token: write  # Required for azure/login OIDC
#       steps:
#         # Step 1: Authenticate to Azure (required before this action)
#         # azure-sdk-internal-AzureSDKEngKeyVault Secrets connection need to work with EngSys to add OIDC credentials
#         - uses: azure/login@v2
#           with:
#             client-id: 5786d1fb-187e-4ca9-9a81-ab89ea278986
#             tenant-id: 72f988bf-86f1-41af-91ab-2d7cd011db47
#             subscription-id: a18897a6-7e44-457d-9260-f2854c0aca42
#
#         # Step 2: Mint GitHub App token
#         - uses: ./eng/common/actions/login-to-github
#           with:
#             token-owners: Azure
#
#         # Step 3: Use the token (available as env var in all subsequent steps)
#         - run: gh pr list --repo Azure/azure-sdk-tools
#           env:
#             GH_TOKEN: ${{ env.GH_TOKEN }}
#
# Usage (multiple owners):
#         - uses: ./eng/common/actions/login-to-github
#           with:
#             token-owners: Azure,azure-sdk,MicrosoftDocs
#
#         - run: gh pr list --repo Azure/azure-sdk-tools
#           env:
#             GH_TOKEN: ${{ env.GH_TOKEN_Azure }}
#
# Tokens are exported to GITHUB_ENV so all subsequent steps can reference
# them as ${{ env.GH_TOKEN }} (single owner) or ${{ env.GH_TOKEN_<Owner> }}
# (multiple owners). This matches the Azure DevOps behavior where tokens
# are set as pipeline variables.

name: 'Login to GitHub'
description: 'Mint a GitHub App installation token via Azure Key Vault signing'

inputs:
  token-owners:
    description: >
      Comma-separated list of GitHub organizations or users for which to
      obtain installation tokens (e.g. "Azure" or "Azure,azure-sdk").
    required: false
    default: 'Azure'
  variable-name-prefix:
    description: >
      Prefix for the exported variable name. With a single owner the
      variable is named exactly this (default GH_TOKEN). With multiple
      owners each variable is named <prefix>_<owner>.
    required: false
    default: 'GH_TOKEN'
  key-vault-name:
    description: 'Azure Key Vault name containing the signing key'
    required: false
    default: 'azuresdkengkeyvault'
  key-name:
    description: 'Name of the RSA key in Key Vault'
    required: false
    default: 'azure-sdk-automation'
  app-id:
    description: 'GitHub App numeric ID'
    required: false
    default: '1086291'

runs:
  using: 'composite'
  steps:
    - shell: pwsh
      run: |
        $scriptPath = Join-Path "${{ github.action_path }}" ".." ".." "scripts" "login-to-github.ps1"
        $owners = '${{ inputs.token-owners }}' -split ',' | ForEach-Object { $_.Trim() }
        & $scriptPath `
          -KeyVaultName '${{ inputs.key-vault-name }}' `
          -KeyName '${{ inputs.key-name }}' `
          -GitHubAppId '${{ inputs.app-id }}' `
          -InstallationTokenOwners $owners `
          -VariableNamePrefix '${{ inputs.variable-name-prefix }}'
