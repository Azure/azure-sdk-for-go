parameters:
  DependsOn: Build
  TestPipeline: false
  ServiceDirectory: ''

stages:
  - stage: CheckRelease
    variables:
      - template: /eng/pipelines/templates/variables/globals.yml
    displayName: 'Check Release: ${{ parameters.ServiceDirectory }}'
    dependsOn: ${{ parameters.DependsOn }}
    condition: and(succeeded(), ne(variables['SetDevVersion'], 'true'), ne(variables['Skip.Release'], 'true'), ne(variables['Build.Repository.Name'], 'Azure/azure-sdk-for-go-pr'), ne(variables.UseAzcoreFromMain, 'true'))
    jobs:
      - job: CheckReleaseJob
        displayName: "Check whether need to release"
        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          image: azsdk-pool-mms-ubuntu-2004-1espt
          os: linux
        steps:
          - task: PowerShell@2
            name: Verify
            inputs:
              filePath: ./eng/scripts/Verify-NeedToRelease.ps1
              ${{ if startsWith(parameters.ServiceDirectory, '../') }}:
                arguments: >
                  -PackageName "${{replace(parameters.ServiceDirectory, '../', '')}}"
                  -ServiceDirectory '${{ parameters.ServiceDirectory }}'
                  -repoId Azure/azure-sdk-for-go
                  -workingDirectory $(System.DefaultWorkingDirectory)
              ${{ else }}:
                arguments: >
                  -PackageName 'sdk/${{ parameters.ServiceDirectory }}'
                  -ServiceDirectory '${{ parameters.ServiceDirectory }}'
                  -repoId Azure/azure-sdk-for-go
                  -workingDirectory $(System.DefaultWorkingDirectory)
              pwsh: true
            env:
              GH_TOKEN: $(azuresdk-github-pat)
  - stage: Release
    variables:
      - template: /eng/pipelines/templates/variables/globals.yml
    displayName: 'Release: ${{ parameters.ServiceDirectory }}'
    dependsOn: CheckRelease
      # condition: and(succeeded(), eq(dependencies.CheckRelease.outputs['CheckReleaseJob.Verify.NeedToRelease'], 'true'))
    jobs:
      - deployment: TagRepository
        displayName: "Create release tag"
        condition: and(succeeded(), ne(variables['Skip.TagRepository'], 'true'))
        environment: github

        pool:
          name: azsdk-pool-mms-ubuntu-2004-general
          image: azsdk-pool-mms-ubuntu-2004-1espt
          os: linux

        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - download: current
                  artifact: 'PackageInfo'
                - template: /eng/common/pipelines/templates/steps/retain-run.yml
                - template: /eng/common/pipelines/templates/steps/verify-changelog.yml
                  parameters:
                    ServiceDirectory: '${{parameters.ServiceDirectory}}'
                    ${{ if startsWith(parameters.ServiceDirectory, '../') }}:
                      PackageName: "${{replace(parameters.ServiceDirectory, '../', '')}}"
                    ${{ else }}:
                      PackageName: 'sdk/${{parameters.ServiceDirectory}}'
                    ForRelease: true
                - template: /eng/common/pipelines/templates/steps/verify-restapi-spec-location.yml
                  parameters:
                    ${{ if startsWith(parameters.ServiceDirectory, '../') }}:
                      PackageName: "${{replace(parameters.ServiceDirectory, '../', '')}}"
                    ${{ else }}:
                      PackageName: 'sdk/${{parameters.ServiceDirectory}}'
                    ServiceDirectory: ${{parameters.ServiceDirectory}}
                    ArtifactLocation: $(Pipeline.Workspace)
                - task: PowerShell@2
                  displayName: 'Verify no replace directives in go.mod file'
                  inputs:
                    targetType: 'filePath'
                    filePath: ./eng/scripts/validate_go_mod.ps1
                    arguments: '${{ parameters.ServiceDirectory }}'
                    pwsh: true
                      #                - template: /eng/common/pipelines/templates/steps/create-tags-and-git-release.yml
                      #                  parameters:
                      #                    ArtifactLocation: $(Build.SourcesDirectory)/sdk/${{ parameters.ServiceDirectory }}
                      #                    PackageFilter: sdk/${{ parameters.ServiceDirectory }}
                      #                    ReleaseSha: $(Build.SourceVersion)
                      #                    RepoId: Azure/azure-sdk-for-go
                      #                    WorkingDirectory: $(System.DefaultWorkingDirectory)

                      #      - ${{ if not(and(startsWith(parameters.ServiceDirectory, 'resourcemanager'), ne(parameters.ServiceDirectory, 'resourcemanager/internal'))) }}:
                      #        - deployment: UpdatePackageVersion
                      #          displayName: "Update Package Version"
                      #          condition: and(succeeded(), ne(variables['Skip.UpdatePackageVersion'], 'true'))
                      #          environment: github
                      #          dependsOn: TagRepository
                      #
                      #          pool:
                      #            name: azsdk-pool-mms-ubuntu-2004-general
                      #            image: azsdk-pool-mms-ubuntu-2004-1espt
                      #            os: linux
                      #
                      #          strategy:
                      #            runOnce:
                      #              deploy:
                      #                steps:
                      #                  - checkout: self
                      #                  - pwsh: |
                      #                      eng/scripts/Update-ModuleVersion.ps1 -ModulePath 'sdk/${{parameters.ServiceDirectory}}'
                      #                    displayName: Increment package version
                      #                  - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
                      #                    parameters:
                      #                      PRBranchName: increment-package-version-${{ parameters.ServiceDirectory }}-$(Build.BuildId)
                      #                      CommitMsg: "Increment package version after release of ${{ parameters.ServiceDirectory }}"
                      #                      PRTitle: "Increment version for ${{ parameters.ServiceDirectory }} releases"
                      #                      CloseAfterOpenForTesting: '${{ parameters.TestPipeline }}'
