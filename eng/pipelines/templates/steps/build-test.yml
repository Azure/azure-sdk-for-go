parameters:
  - name:  ServiceDirectory
    type: string
    default: ''
  - name:  GoWorkspace
    type: string
    default: ''
  - name:  Scope
    type: string
    default: 'sdk/...'
  - name:  Image
    type: string
    default: ''
  - name:  GoVersion
    type: string
    default: ''
  - name: EnvVars
    type: object
    default: {}

steps:
  - task: Powershell@2
    displayName: Build
    env:
      GO111MODULE: 'on'
    inputs:
      targetType: filePath
      pwsh: true
      filePath: eng/scripts/build.ps1
      arguments: -filter '${{ parameters.ServiceDirectory }}'
      workingDirectory: '${{ parameters.GoWorkspace }}'

  - task: Powershell@2
    displayName: Vet
    env:
      GO111MODULE: 'on'
    inputs:
      targetType: filePath
      pwsh: true
      filePath: eng/scripts/build.ps1
      arguments: -vet -skipBuild -filter '${{ parameters.ServiceDirectory }}'
      workingDirectory: '${{ parameters.GoWorkspace }}'

  - template: /eng/common/testproxy/test-proxy-docker.yml

  - task: PowerShell@2
    displayName: 'Run Tests'
    inputs:
      targetType: 'filePath'
      filePath: ./eng/scripts/run_tests.ps1
      workingDirectory: '${{parameters.GoWorkspace}}'
      arguments: '${{parameters.ServiceDirectory}}'
      pwsh: true
    env:
      GO111MODULE: 'on'

  - pwsh: ./eng/scripts/create_coverage.ps1 ${{parameters.ServiceDirectory}}
    workingDirectory: '${{parameters.GoWorkspace}}'
    displayName: 'Create Coverage'
    env:
      GO111MODULE: 'off'

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testRunner: JUnit
      testResultsFiles: '${{parameters.GoWorkspace}}sdk/${{parameters.ServiceDirectory}}/**/report.xml'
      testRunTitle: 'Go ${{ parameters.GoVersion }} on ${{ parameters.Image }}'
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@1
    condition: succeededOrFailed()
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '${{parameters.GoWorkspace}}sdk/${{parameters.ServiceDirectory}}/coverage.xml'
      additionalCodeCoverageFiles: '${{parameters.GoWorkspace}}sdk/${{parameters.ServiceDirectory}}/coverage.html'
      failIfCoverageEmpty: true
