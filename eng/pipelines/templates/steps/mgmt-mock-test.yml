parameters:
  - name:  ServiceDirectory
    type: string
    default: ''
  - name:  GoWorkspace
    type: string
    default: ''

steps:
  - task: Powershell@2
    displayName: 'Create Mock Test'
    env:
      GO111MODULE: 'on'
    inputs:
      targetType: filePath
      pwsh: true
      filePath: eng/scripts/Invoke-MgmtTestgen.ps1
      arguments: -filter '${{ parameters.ServiceDirectory }}' -cleanGenerated -format -tidy -generateMockTest

  - task: Powershell@2
    displayName: 'Build and Vet'
    env:
      GO111MODULE: 'on'
    inputs:
      targetType: filePath
      pwsh: true
      filePath: eng/scripts/Invoke-MgmtTestgen.ps1
      arguments: -filter '${{ parameters.ServiceDirectory }}' -vet

  - task: Powershell@2
    displayName: 'Mock Test'
    env:
      GO111MODULE: 'on'
    inputs:
      targetType: filePath
      pwsh: true
      filePath: eng/scripts/Invoke-MgmtMockTest.ps1
      arguments: -filter '${{ parameters.ServiceDirectory }}'

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: $(Build.SourcesDirectory)/sdk/${{parameters.ServiceDirectory}}/
      includeRootFolder: true
      archiveFile: '$(Build.ArtifactStagingDirectory)/MockTestCodeAndReport.zip'
      
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Code and Report'
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)/MockTestCodeAndReport.zip'
      artifactName: MockTestCodeAndReport

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testRunner: JUnit
      testResultsFiles: '$(Build.SourcesDirectory)/sdk/${{parameters.ServiceDirectory}}/**/report.xml'
      testRunTitle: 'Test result on ${{ parameters.ServiceDirectory }}'
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@1
    condition: succeededOrFailed()
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(Build.SourcesDirectory)/sdk/${{parameters.ServiceDirectory}}/coverage.xml'
      additionalCodeCoverageFiles: '$(Build.SourcesDirectory)/sdk/${{parameters.ServiceDirectory}}/coverage.html'
      failIfCoverageEmpty: true