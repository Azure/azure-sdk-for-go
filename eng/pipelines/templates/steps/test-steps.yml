parameters:
  - name: EnvVars
    type: object
    default: {}
  - name: TestRunTime
    type: string
    default: '600s'
  - name: EnableRaceDetector
    type: boolean
    default: false
  - name: ServiceConnection
    type: string
    default: ''
  - name: Packages
    type: string
    default: ''
  - name: Condition
    type: string
    default: true

steps:
  - task: PowerShell@2
    displayName: Run Tests - v$(GoVersion)
    condition: and(succeeded(), ${{ parameters.Condition }}))
    inputs:
      targetType: 'filePath'
      filePath: ./eng/scripts/run_tests.ps1
      arguments: '"${{ parameters.Packages }}" ${{ parameters.TestRunTime }} $${{ parameters.EnableRaceDetector }}'
      pwsh: true
    env:
      GO111MODULE: 'on'
      PROXY_CERT: $(Build.SourcesDirectory)/eng/common/testproxy/dotnet-devcert.crt
      ${{ insert }}: ${{ parameters.EnvVars }}
      GOTRACEBACK: all
      AZURE_SDK_GO_LOGGING: all

  - task: PowerShell@2
    displayName: 'Build Performance Tests'
    condition: and(succeeded(), ${{ parameters.Condition }}))
    inputs:
      targetType: 'filePath'
      filePath: ./eng/scripts/Build_Perf.ps1
      arguments: '"${{ parameters.Packages }}" $$(UseAzcoreFromMain)'
      pwsh: true