# Go

These settings apply only when `--go` is specified on the command line.

``` yaml
input-file:
- https://github.com/Azure/azure-rest-api-specs/blob/faa4cce91d8bed10465eed26a25672f71f15c0d1/specification/cognitiveservices/data-plane/AzureOpenAI/inference/preview/2023-12-01-preview/generated.json

output-folder: ../azopenai
clear-output-folder: false
module: github.com/Azure/azure-sdk-for-go/sdk/ai/azopenai
license-header: MICROSOFT_MIT_NO_VERSION
openapi-type: data-plane
go: true
use: "@autorest/go@4.0.0-preview.52"
title: "OpenAI"
slice-elements-byval: true
# can't use this since it removes an innererror type that we want ()
# remove-non-reference-schema: true
```

## Transformations

Fix deployment and endpoint parameters so they show up in the right spots

``` yaml
directive:
  # Add x-ms-parameter-location to parameters in x-ms-parameterized-host
  - from: swagger-document
    where: $["x-ms-parameterized-host"].parameters.0
    debug: true
    transform: $["x-ms-parameter-location"] = "client";
  # Make deploymentId a client parameter
  # This must be done in each operation as the parameter is not defined in the components section
  - from: swagger-document
    where: $.paths..parameters..[?(@.name=='deploymentId')]
    transform: $["x-ms-parameter-location"] = "client";
```

## Polymorphic adjustments

The polymorphic _input_ models all expose the discriminator but it's ignored when serializing 
(ie, each type already knows the value and fills it in). So we'll just hide it.

`ChatRequestMessageClassification.Role`

```yaml
directive:
  - from: swagger-document
    where: $.definitions.ChatRequestMessage
    transform: $.properties.role["x-ms-client-name"] = "InternalRoleRename"
  - from:
    - models.go
    - models_serde.go
    where: $
    transform: return $.replace(/InternalRoleRename/g, "role")
```

`AzureChatExtensionConfigurationClassification.Type`

```yaml
directive:
  - from: swagger-document
    where: $.definitions.AzureChatExtensionConfiguration
    transform: $.properties.type["x-ms-client-name"] = "InternalChatExtensionTypeRename"
  - from:
    - models.go
    - models_serde.go
    where: $
    transform: return $.replace(/InternalChatExtensionTypeRename/g, "configType")
```

`OnYourDataAuthenticationOptionsClassification.Type`

```yaml
directive:
  - from: swagger-document
    where: $.definitions.OnYourDataAuthenticationOptions
    transform: $.properties.type["x-ms-client-name"] = "InternalOYDAuthTypeRename"
  - from:
    - models.go
    - models_serde.go
    where: $
    transform: return $.replace(/InternalOYDAuthTypeRename/g, "configType")
```

## Model -> DeploymentName

```yaml
directive:
  - from: swagger-document
    where: $.definitions
    transform: |
      $["AudioTranscriptionOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
      $["AudioTranslationOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
      $["ChatCompletionsOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
      $["CompletionsOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
      $["EmbeddingsOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
      $["ImageGenerationOptions"].properties["model"]["x-ms-client-name"] = "DeploymentName";
```

## Cleanup the audio transcription APIs

We're wrapping the audio translation and transcription APIs, so we can eliminate some of these autogenerated
models and functions.

```yaml
directive:
  # kill models
  - from:
    - models.go
    - models_serde.go
    where: $
    transform: |
      return $
        .replace(/type XMSPathsHksgfdDeploymentsDeploymentidAudioTranscriptionsOverloadGetaudiotranscriptionasresponseobjectPostRequestbodyContentMultipartFormDataSchema struct.+?\n}/s, "")
        .replace(/\/\/ MarshalJSON implements the json.Marshaller interface for type XMSPathsHksgfdDeploymentsDeploymentidAudioTranscriptionsOverloadGetaudiotranscriptionasresponseobjectPostRequestbodyContentMultipartFormDataSchema.+?\n}/s, "")
        .replace(/\/\/ UnmarshalJSON implements the json.Unmarshaller interface for type XMSPathsHksgfdDeploymentsDeploymentidAudioTranscriptionsOverloadGetaudiotranscriptionasresponseobjectPostRequestbodyContentMultipartFormDataSchema.+?\n}/s, "")
        .replace(/type XMSPaths1Ak7Ov3DeploymentsDeploymentidAudioTranslationsOverloadGetaudiotranslationasresponseobjectPostRequestbodyContentMultipartFormDataSchema struct.+?\n}/s, "")
        .replace(/\/\/ MarshalJSON implements the json.Marshaller interface for type XMSPaths1Ak7Ov3DeploymentsDeploymentidAudioTranslationsOverloadGetaudiotranslationasresponseobjectPostRequestbodyContentMultipartFormDataSchema.+?\n}/s, "")
        .replace(/\/\/ UnmarshalJSON implements the json.Unmarshaller interface for type XMSPaths1Ak7Ov3DeploymentsDeploymentidAudioTranslationsOverloadGetaudiotranslationasresponseobjectPostRequestbodyContentMultipartFormDataSchema.+?\n}/s, "");
  # kill API functions
  - from:
    - client.go
    where: $
    transform: |
      return $
        .replace(/\/\/ GetAudioTranscriptionAsPlainText -.+?\n}/s, "")
        .replace(/\/\/ GetAudioTransclationAsPlainText -.+?\n}/s, "");
```

## Move the Azure extensions into their own section of the options

```yaml
# TODO: rename and move.
```

We've moved these 'extension' data types into their own field. 

```yaml
directive:
- from: swagger-document
  where: $.definitions.ChatCompletionsOptions.properties.dataSources
  transform: $["x-ms-client-name"] = "AzureExtensionsOptions"
```

## Trim the Error object to match our Go conventions
 
```yaml
directive:
  - from: swagger-document
    where: $.definitions["Azure.Core.Foundations.Error"]
    debug: true
    transform: |
      $.properties = { 
        code: $.properties["code"],
        message: {
          ...$.properties["message"],
          "x-ms-client-name": "InternalErrorMessageRename"
        },
      };
      $["x-ms-client-name"] = "Error";
  
  - from: swagger-document
    where: $.definitions
    transform: delete $["Azure.Core.Foundations.InnerError"];

  - from: 
    - models.go
    - models_serde.go
    where: $
    transform: return $.replace(/InternalErrorMessageRename/g, "message");
```

Other misc fixes

```yaml
directive:
  - from: swagger-document
    where: $..paths["/deployments/{deploymentId}/completions"].post.requestBody
    transform: $["required"] = true;
  - from: swagger-document
    where: $.paths["/deployments/{deploymentId}/embeddings"].post.requestBody
    transform: $["required"] = true;

  # get rid of these auto-generated LRO status methods that aren't exposed.
  - from: swagger-document
    where: $.paths
    transform: delete $["/operations/images/{operationId}"]

  # Remove stream property from CompletionsOptions and ChatCompletionsOptions
  - from: swagger-document
    where: $.components.schemas["CompletionsOptions"]
    transform: delete $.properties.stream;
  - from: swagger-document
    where: $.components.schemas["ChatCompletionsOptions"]
    transform: delete $.properties.stream; 

  # Replace anyOf schemas with an empty schema (no type) to get an "any" type generated
  - from: swagger-document
    where: '$.components.schemas["EmbeddingsOptions"].properties["input"]'
    transform: delete $.anyOf;

  - from: swagger-document
    where: $.paths["/images/generations:submit"].post
    transform: $["x-ms-long-running-operation"] = true;

  # Fix autorest bug
  - from: swagger-document
    where: $.components.schemas["BatchImageGenerationOperationResponse"].properties
    transform: |
      $.result["$ref"] = "#/components/schemas/ImageGenerations"; delete $.allOf;
      $.status["$ref"] = "#/components/schemas/AzureOpenAIOperationState"; delete $.allOf;
      $.error["$ref"] = "#/components/schemas/Azure.Core.Foundations.Error"; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ChatMessage"].properties.role
    transform: $["$ref"] = "#/components/schemas/ChatRole"; delete $.oneOf;
  - from: swagger-document
    where: $.components.schemas["Choice"].properties.finish_reason
    transform: $["$ref"] = "#/components/schemas/CompletionsFinishReason"; delete $.oneOf;
  - from: swagger-document
    where: $.components.schemas["ImageOperation"].properties.status
    transform: $["$ref"] = $.anyOf[0]["$ref"];delete $.anyOf;
  - from: swagger-document
    where: $.components.schemas.ImageGenerationOptions.properties
    transform: |
      $.size["$ref"] = "#/components/schemas/ImageSize"; delete $.allOf;
      $.response_format["$ref"] = "#/components/schemas/ImageGenerationResponseFormat"; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ImageOperationResponse"].properties
    transform: |
      $.status["$ref"] = "#/components/schemas/State"; delete $.status.allOf;
      $.result["$ref"] = "#/components/schemas/ImageResponse"; delete $.status.allOf;      
  - from: swagger-document
    where: $.components.schemas["ImageOperationStatus"].properties.status
    transform: $["$ref"] = "#/components/schemas/State"; delete $.allOf; 
  - from: swagger-document
    where: $.components.schemas["ContentFilterResult"].properties.severity
    transform: $.$ref = $.allOf[0].$ref; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ChatChoice"].properties.finish_reason
    transform: $["$ref"] = "#/components/schemas/CompletionsFinishReason"; delete $.oneOf;
  - from: swagger-document
    where: $.components.schemas["ContentFilterResults"].properties.sexual
    transform: $.$ref = $.allOf[0].$ref; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ContentFilterResults"].properties.hate
    transform: $.$ref = $.allOf[0].$ref; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ContentFilterResults"].properties.self_harm
    transform: $.$ref = $.allOf[0].$ref; delete $.allOf;
  - from: swagger-document
    where: $.components.schemas["ContentFilterResults"].properties.violence
    transform: $.$ref = $.allOf[0].$ref; delete $.allOf;
```

Changes for audio/whisper APIs.

```yaml
directive:
  # the whisper operations are really long since they are a conglomeration of _all_ the
  # possible return types.
  - rename-operation:
      from: GetAudioTranscriptionAsResponseObject
      to: GetAudioTranscriptionInternal
  - rename-operation:
      from: GetAudioTranslationAsResponseObject
      to: GetAudioTranslationInternal

  - from: swagger-document
    where: $["x-ms-paths"]["/deployments/{deploymentId}/audio/translations?_overload=getAudioTranslationAsResponseObject"].post
    transform: $.operationId = "GetAudioTranslationInternal"
  - from: swagger-document
    where: $["x-ms-paths"]["/deployments/{deploymentId}/audio/transcriptions?_overload=getAudioTranscriptionAsResponseObject"].post
    transform: $.operationId = "GetAudioTranscriptionInternal"

  # hide the generated functions, in favor of our public wrappers.
  - from: 
    - client.go
    - models.go
    - models_serde.go
    - response_types.go
    - options.go
    where: $
    transform: |
      return $
        .replace(/GetAudioTranscriptionInternal([^){ ]*)/g, "getAudioTranscriptionInternal$1")
        .replace(/GetAudioTranslationInternal([^){ ]*)/g, "getAudioTranslationInternal$1");

  # some multipart fixing
  - from: client.go
    where: $
    transform: |
      return $
        .replace(/(func.*getAudio(?:Translation|Transcription)InternalCreateRequest\(.+?)options/g, "$1body")
        .replace(/runtime\.SetMultipartFormData\(.+?\)/sg, "setMultipartFormData(req, file, *body)")

  # response type parsing (can be text/plain _or_ JSON)
  - from: client.go
    where: $
    transform: |
      return $
      .replace(/client\.getAudioTranscriptionInternalHandleResponse/g, "getAudioTranscriptionInternalHandleResponse")
        .replace(/client\.getAudioTranslationInternalHandleResponse/g, "getAudioTranslationInternalHandleResponse")

  # fix the file parameter to be a []byte.
  - from: client.go
    where: $
    transform: return $.replace(/^(func \(client \*Client\) getAudioTrans.+?)file string,(.+)$/mg, "$1file []byte,$2")
```

```yaml
directive:
  - from: swagger-document
    where: $.components.schemas
    transform: |
      let fix = (v) => { if (v.allOf != null) { v.$ref = v.allOf[0].$ref; delete v.allOf; } };
      
      fix($.AudioTranscriptionOptions.properties.response_format);
      fix($.AudioTranscription.properties.task);

      fix($.AudioTranslationOptions.properties.response_format);
      fix($.AudioTranslation.properties.task);

  - from:
    - options.go
    - models_serde.go
    - models.go
    where: $
    transform: |
      return $
        .replace(/AvgLogprob \*float32/g, "AvgLogProb *float32")
        .replace(/(a|c)\.AvgLogprob/g, "$1.AvgLogProb")
```

```yaml
directive:
  # Fix "AutoGenerated" models
  - from: swagger-document
    where: $.components.schemas["ChatCompletions"].properties.usage
    transform: >
      delete $.allOf;
      $["$ref"] = "#/components/schemas/CompletionsUsage";
  - from: swagger-document
    where: $.components.schemas["Completions"].properties.usage
    transform: >
      delete $.allOf;
      $["$ref"] = "#/components/schemas/CompletionsUsage";

  #
  # strip out the deploymentID validation code - we absorbed this into the endpoint.
  #
	# urlPath := "/deployments/{deploymentId}/embeddings"
	# if client.deploymentID == "" {
	# 	return nil, errors.New("parameter client.deploymentID cannot be empty")
	# }
	# urlPath = strings.ReplaceAll(urlPath, "{deploymentId}", url.PathEscape(client.deploymentID))
  - from: client.go
    where: $
    transform: >-
      return $.replace(
        /(\s+)urlPath\s*:=\s*"\/deployments\/\{deploymentId\}\/([^"]+)".+?url\.PathEscape.+?\n/gs, 
        "$1urlPath := \"$2\"\n")

  # Unexport the the poller state enum.
  - from: 
      - constants.go
      - models.go
    where: $
    transform: return $.replace(/AzureOpenAIOperationState/g, "azureOpenAIOperationState");

  # splice out the auto-generated `deploymentID` field from the client
  - from: client.go
    where: $
    transform: >-
      return $.replace(
        /(type Client struct[^}]+})/s, 
        "type Client struct {\ninternal *azcore.Client; clientData;\n}")

  - from: 
    - models_serde.go
    - models.go
    where: $
    transform: | 
      return $
        // remove some types that were generated to support the recursive error.
        .replace(/\/\/ AzureCoreFoundationsInnerErrorInnererror.+?\n}/s, "")
        // also, remove its marshalling functions
        .replace(/\/\/ (Unmarshal|Marshal)JSON implements[^\n]+?for type AzureCoreFoundationsInnerErrorInnererror.+?\n}/sg, "")
        .replace(/\/\/ AzureCoreFoundationsErrorInnererror.+?\n}/s, "")
        .replace(/\/\/ (Unmarshal|Marshal)JSON implements[^\n]+?for type AzureCoreFoundationsErrorInnererror.+?\n}/sg, "")
        .replace(/\/\/ AzureCoreFoundationsErrorResponseError.+?\n}/s, "")
        .replace(/\/\/ (Unmarshal|Marshal)JSON implements[^\n]+?for type AzureCoreFoundationsErrorResponseError.+?\n}/sg, "")
        .replace(/\/\/ AzureCoreFoundationsErrorResponse.+?\n}/s, "")
        .replace(/\/\/ (Unmarshal|Marshal)JSON implements[^\n]+?for type AzureCoreFoundationsErrorResponse.+?\n}/sg, "")

        // Remove any references to the type and replace them with InnerError.
        .replace(/Innererror \*(AzureCoreFoundationsInnerErrorInnererror|AzureCoreFoundationsErrorInnererror)/g, "InnerError *InnerError")

        // Fix the marshallers/unmarshallers to use the right case.
        .replace(/(a|c).Innererror/g, '$1.InnerError')

        // We have two "inner error" types that are identical (ErrorInnerError and InnerError). Let's eliminate the one that's not actually directly referenced.
        .replace(/\/\/azureCoreFoundationsInnerError.+?\n}/s, "")
        
        //
        // Fix the AzureCoreFoundation naming to match our style.
        //
        .replace(/AzureCoreFoundations/g, "")
  - from: constants.go
    where: $
    transform: >-
      return $.replace(
        /type ServiceAPIVersions string.+PossibleServiceAPIVersionsValues.+?\n}/gs, 
        "")

  # delete client name prefix from method options and response types
  - from:
      - client.go
      - models.go
      - options.go
      - response_types.go
    where: $
    transform: return $.replace(/Client(\w+)((?:Options|Response))/g, "$1$2");

  # allow interception of formatting the URL path
  - from: client.go
    where: $
    transform: |
      return $
        .replace(/runtime\.JoinPaths\(client.endpoint, urlPath\)/g, "client.formatURL(urlPath, getDeployment(body))");

  - from: models.go
    where: $
    transform: |
      return $.replace(/(type ImageGenerations struct.+?)Data any/sg, "$1Data []ImageGenerationsDataItem")

  # delete the auto-generated ImageGenerationsDataItem, we handle that custom
  - from: models.go
    where: $
    transform: return $.replace(/\/\/ ImageGenerationsDataItem represents[^}]+}/s, "");

  # rename the image constants
  - from: constants.go
    where: $
    transform: |
      return $.replace(/ImageSizeFiveHundredTwelveX512/g, "ImageSize512x512")
        .replace(/ImageSizeOneThousandTwentyFourX1024/g, "ImageSize1024x1024")
        .replace(/ImageSizeTwoHundredFiftySixX256/g, "ImageSize256x256");

  # scrub the Image(Payload|Location) deserializers.
  - from: models_serde.go
    where: $
    transform: |
      return $.replace(/\/\/ UnmarshalJSON implements the json.Unmarshaller interface for type ImagePayload.+?\n}/s, "")
        .replace(/\/\/ MarshalJSON implements the json.Marshaller interface for type ImagePayload.+?\n}/s, "")
        .replace(/\/\/ UnmarshalJSON implements the json.Unmarshaller interface for type ImageLocation.+?\n}/s, "")
        .replace(/\/\/ MarshalJSON implements the json.Marshaller interface for type ImageLocation.+?\n}/s, "");

  # BUG: ChatCompletionsOptionsFunctionCall is another one of those "here's mutually exclusive values" options...
  - from: 
    - models.go
    - models_serde.go
    where: $
    transform: |
      return $
        .replace(/populateAny\(objectMap, "function_call", c.FunctionCall\)/, 'populate(objectMap, "function_call", c.FunctionCall)')
        .replace(/\/\/ ChatCompletionsOptionsFunctionCall.+?\n}/, "")
        .replace(/FunctionCall any/, "FunctionCall *ChatCompletionsOptionsFunctionCall");
  
  # fix some casing
  - from: 
    - client.go
    - models.go
    - models_serde.go
    - options.go
    - response_types.go
    where: $
    transform: return $.replace(/Logprobs/g, "LogProbs")

  - from: constants.go
    where: $
    transform: return $.replace(/\/\/ PossibleazureOpenAIOperationStateValues returns.+?\n}/s, "");

  # fix incorrect property name for content filtering
  # TODO: I imagine we should able to fix this in the tsp?
  - from: models_serde.go
    where: $
    transform: |
      return $
        .replace(/		case "selfHarm":/g, '		case "self_harm":')
        .replace(/populate\(objectMap, "selfHarm", c.SelfHarm\)/g, 'populate(objectMap, "self_harm", c.SelfHarm)');

  - from: client.go
    where: $
    transform: return $.replace(/runtime\.NewResponseError/sg, "client.newError");

  # Make the Azure extensions internal - we expose these through the GetChatCompletions*() functions
  # and just treat which endpoint we use as an implementation detail.
  - from: client.go
    where: $
    transform: |
      return $
        .replace(/GetChatCompletionsWithAzureExtensions([ (])/g, "getChatCompletionsWithAzureExtensions$1")
        .replace(/GetChatCompletions([ (])/g, "getChatCompletions$1");

  # try to fix some of the generated types.

  - from: constants.go
    where: $
    transform: |
      return $.replace(
        /(AzureChatExtensionTypeAzureCognitiveSearch AzureChatExtensionType)/, 
        "// AzureChatExtensionTypeAzureCognitiveSearch enables the use of an Azure Cognitive Search index with chat completions.\n// [AzureChatExtensionConfiguration.Parameter] should be of type [AzureCognitiveSearchChatExtensionConfiguration].\n$1");
  
  # HACK: prompt_filter_results <-> prompt_annotations change
  - from: models_serde.go
    where: $
    transform: return $.replace(/case "prompt_filter_results":/g, 'case "prompt_annotations":\nfallthrough\ncase "prompt_filter_results":')
```
