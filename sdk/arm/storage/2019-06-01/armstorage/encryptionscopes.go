// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for license information.
// Code generated by Microsoft (R) AutoRest Code Generator.
// Changes may cause incorrect behavior and will be lost if the code is regenerated.

package armstorage

import (
	"context"
	"errors"
	"fmt"
	"github.com/Azure/azure-sdk-for-go/sdk/azcore"
	"net/http"
	"net/url"
	"strings"
)

// EncryptionScopesOperations contains the methods for the EncryptionScopes group.
type EncryptionScopesOperations interface {
	// Get - Returns the properties for the specified encryption scope.
	Get(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string) (*EncryptionScopeResponse, error)
	// List - Lists all the encryption scopes available under the specified storage account.
	List(resourceGroupName string, accountName string) (EncryptionScopeListResultPager, error)
	// Patch - Update encryption scope properties as specified in the request body. Update fails if the specified encryption scope does not already exist.
	Patch(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*EncryptionScopeResponse, error)
	// Put - Synchronously creates or updates an encryption scope under the specified storage account. If an encryption scope is already created and a subsequent request is issued with different properties, the encryption scope properties will be updated per the specified request.
	Put(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*EncryptionScopeResponse, error)
}

// encryptionScopesOperations implements the EncryptionScopesOperations interface.
type encryptionScopesOperations struct {
	*Client
	subscriptionID string
}

// Get - Returns the properties for the specified encryption scope.
func (client *encryptionScopesOperations) Get(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string) (*EncryptionScopeResponse, error) {
	req, err := client.getCreateRequest(resourceGroupName, accountName, encryptionScopeName)
	if err != nil {
		return nil, err
	}
	resp, err := client.p.Do(ctx, req)
	if err != nil {
		return nil, err
	}
	result, err := client.getHandleResponse(resp)
	if err != nil {
		return nil, err
	}
	return result, nil
}

// getCreateRequest creates the Get request.
func (client *encryptionScopesOperations) getCreateRequest(resourceGroupName string, accountName string, encryptionScopeName string) (*azcore.Request, error) {
	urlPath := "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{accountName}/encryptionScopes/{encryptionScopeName}"
	urlPath = strings.ReplaceAll(urlPath, "{resourceGroupName}", url.PathEscape(resourceGroupName))
	urlPath = strings.ReplaceAll(urlPath, "{accountName}", url.PathEscape(accountName))
	urlPath = strings.ReplaceAll(urlPath, "{subscriptionId}", url.PathEscape(client.subscriptionID))
	urlPath = strings.ReplaceAll(urlPath, "{encryptionScopeName}", url.PathEscape(encryptionScopeName))
	u, err := client.u.Parse(urlPath)
	if err != nil {
		return nil, err
	}
	query := u.Query()
	query.Set("api-version", "2019-06-01")
	u.RawQuery = query.Encode()
	req := azcore.NewRequest(http.MethodGet, *u)
	return req, nil
}

// getHandleResponse handles the Get response.
func (client *encryptionScopesOperations) getHandleResponse(resp *azcore.Response) (*EncryptionScopeResponse, error) {
	if !resp.HasStatusCode(http.StatusOK) {
		return nil, client.getHandleError(resp)
	}
	result := EncryptionScopeResponse{RawResponse: resp.Response}
	return &result, resp.UnmarshalAsJSON(&result.EncryptionScope)
}

// getHandleError handles the Get error response.
func (client *encryptionScopesOperations) getHandleError(resp *azcore.Response) error {
	var err ErrorResponse
	if err := resp.UnmarshalAsJSON(&err); err != nil {
		return err
	}
	return err
}

// List - Lists all the encryption scopes available under the specified storage account.
func (client *encryptionScopesOperations) List(resourceGroupName string, accountName string) (EncryptionScopeListResultPager, error) {
	req, err := client.listCreateRequest(resourceGroupName, accountName)
	if err != nil {
		return nil, err
	}
	return &encryptionScopeListResultPager{
		pipeline:  client.p,
		request:   req,
		responder: client.listHandleResponse,
		advancer: func(resp *EncryptionScopeListResultResponse) (*azcore.Request, error) {
			u, err := url.Parse(*resp.EncryptionScopeListResult.NextLink)
			if err != nil {
				return nil, fmt.Errorf("invalid NextLink: %w", err)
			}
			if u.Scheme == "" {
				return nil, fmt.Errorf("no scheme detected in NextLink %s", *resp.EncryptionScopeListResult.NextLink)
			}
			return azcore.NewRequest(http.MethodGet, *u), nil
		},
	}, nil
}

// listCreateRequest creates the List request.
func (client *encryptionScopesOperations) listCreateRequest(resourceGroupName string, accountName string) (*azcore.Request, error) {
	urlPath := "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{accountName}/encryptionScopes"
	urlPath = strings.ReplaceAll(urlPath, "{resourceGroupName}", url.PathEscape(resourceGroupName))
	urlPath = strings.ReplaceAll(urlPath, "{accountName}", url.PathEscape(accountName))
	urlPath = strings.ReplaceAll(urlPath, "{subscriptionId}", url.PathEscape(client.subscriptionID))
	u, err := client.u.Parse(urlPath)
	if err != nil {
		return nil, err
	}
	query := u.Query()
	query.Set("api-version", "2019-06-01")
	u.RawQuery = query.Encode()
	req := azcore.NewRequest(http.MethodGet, *u)
	return req, nil
}

// listHandleResponse handles the List response.
func (client *encryptionScopesOperations) listHandleResponse(resp *azcore.Response) (*EncryptionScopeListResultResponse, error) {
	if !resp.HasStatusCode(http.StatusOK) {
		return nil, client.listHandleError(resp)
	}
	result := EncryptionScopeListResultResponse{RawResponse: resp.Response}
	return &result, resp.UnmarshalAsJSON(&result.EncryptionScopeListResult)
}

// listHandleError handles the List error response.
func (client *encryptionScopesOperations) listHandleError(resp *azcore.Response) error {
	return errors.New(resp.Status)
}

// Patch - Update encryption scope properties as specified in the request body. Update fails if the specified encryption scope does not already exist.
func (client *encryptionScopesOperations) Patch(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*EncryptionScopeResponse, error) {
	req, err := client.patchCreateRequest(resourceGroupName, accountName, encryptionScopeName, encryptionScope)
	if err != nil {
		return nil, err
	}
	resp, err := client.p.Do(ctx, req)
	if err != nil {
		return nil, err
	}
	result, err := client.patchHandleResponse(resp)
	if err != nil {
		return nil, err
	}
	return result, nil
}

// patchCreateRequest creates the Patch request.
func (client *encryptionScopesOperations) patchCreateRequest(resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*azcore.Request, error) {
	urlPath := "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{accountName}/encryptionScopes/{encryptionScopeName}"
	urlPath = strings.ReplaceAll(urlPath, "{resourceGroupName}", url.PathEscape(resourceGroupName))
	urlPath = strings.ReplaceAll(urlPath, "{accountName}", url.PathEscape(accountName))
	urlPath = strings.ReplaceAll(urlPath, "{subscriptionId}", url.PathEscape(client.subscriptionID))
	urlPath = strings.ReplaceAll(urlPath, "{encryptionScopeName}", url.PathEscape(encryptionScopeName))
	u, err := client.u.Parse(urlPath)
	if err != nil {
		return nil, err
	}
	query := u.Query()
	query.Set("api-version", "2019-06-01")
	u.RawQuery = query.Encode()
	req := azcore.NewRequest(http.MethodPatch, *u)
	return req, req.MarshalAsJSON(encryptionScope)
}

// patchHandleResponse handles the Patch response.
func (client *encryptionScopesOperations) patchHandleResponse(resp *azcore.Response) (*EncryptionScopeResponse, error) {
	if !resp.HasStatusCode(http.StatusOK) {
		return nil, client.patchHandleError(resp)
	}
	result := EncryptionScopeResponse{RawResponse: resp.Response}
	return &result, resp.UnmarshalAsJSON(&result.EncryptionScope)
}

// patchHandleError handles the Patch error response.
func (client *encryptionScopesOperations) patchHandleError(resp *azcore.Response) error {
	var err ErrorResponse
	if err := resp.UnmarshalAsJSON(&err); err != nil {
		return err
	}
	return err
}

// Put - Synchronously creates or updates an encryption scope under the specified storage account. If an encryption scope is already created and a subsequent request is issued with different properties, the encryption scope properties will be updated per the specified request.
func (client *encryptionScopesOperations) Put(ctx context.Context, resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*EncryptionScopeResponse, error) {
	req, err := client.putCreateRequest(resourceGroupName, accountName, encryptionScopeName, encryptionScope)
	if err != nil {
		return nil, err
	}
	resp, err := client.p.Do(ctx, req)
	if err != nil {
		return nil, err
	}
	result, err := client.putHandleResponse(resp)
	if err != nil {
		return nil, err
	}
	return result, nil
}

// putCreateRequest creates the Put request.
func (client *encryptionScopesOperations) putCreateRequest(resourceGroupName string, accountName string, encryptionScopeName string, encryptionScope EncryptionScope) (*azcore.Request, error) {
	urlPath := "/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Storage/storageAccounts/{accountName}/encryptionScopes/{encryptionScopeName}"
	urlPath = strings.ReplaceAll(urlPath, "{resourceGroupName}", url.PathEscape(resourceGroupName))
	urlPath = strings.ReplaceAll(urlPath, "{accountName}", url.PathEscape(accountName))
	urlPath = strings.ReplaceAll(urlPath, "{subscriptionId}", url.PathEscape(client.subscriptionID))
	urlPath = strings.ReplaceAll(urlPath, "{encryptionScopeName}", url.PathEscape(encryptionScopeName))
	u, err := client.u.Parse(urlPath)
	if err != nil {
		return nil, err
	}
	query := u.Query()
	query.Set("api-version", "2019-06-01")
	u.RawQuery = query.Encode()
	req := azcore.NewRequest(http.MethodPut, *u)
	return req, req.MarshalAsJSON(encryptionScope)
}

// putHandleResponse handles the Put response.
func (client *encryptionScopesOperations) putHandleResponse(resp *azcore.Response) (*EncryptionScopeResponse, error) {
	if !resp.HasStatusCode(http.StatusOK, http.StatusCreated) {
		return nil, client.putHandleError(resp)
	}
	result := EncryptionScopeResponse{RawResponse: resp.Response}
	return &result, resp.UnmarshalAsJSON(&result.EncryptionScope)
}

// putHandleError handles the Put error response.
func (client *encryptionScopesOperations) putHandleError(resp *azcore.Response) error {
	var err ErrorResponse
	if err := resp.UnmarshalAsJSON(&err); err != nil {
		return err
	}
	return err
}
